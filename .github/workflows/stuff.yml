name: Stuff

on:
  push:

jobs:
  hot-reloading:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v3
      - uses: dtolnay/rust-toolchain@stable

      - name: Install alsa and udev
        run: sudo apt-get update; sudo apt-get install --no-install-recommends libasound2-dev libudev-dev
        if: runner.os == 'linux'

      - name: Check hot reloading
        shell: pwsh
        run: |
          # first build the example, so that there's no delay when starting it
          cargo build --example asset_processing --no-default-features --features "filesystem_watcher,bevy_asset,multi-threaded,bevy_ci_testing"
          
          # start a subprocess that will modify the asset in 2 seconds
          & { 
            Start-Sleep -s 2
            Set-Variable -Name "file" -Value "./examples/asset/processing/assets/a.cool.ron"
            (Get-Content $file) -replace '"a"', '"modified"' | Add-Content -Path "$file.tmp" -Force
            Remove-Item -Path $file
            Move-Item -Path "$File.tmp" -Destination $file
          } &

          # start the example
          cargo run --example asset_processing --no-default-features --features "filesystem_watcher,bevy_asset,multi-threaded,bevy_ci_testing"

          Write-Output "check processed files"
          if ([bool]((Get-Content examples/asset/processing/imported_assets/a.cool.ron) -ne 'modifiedX')) { exit 1 }
          if ([bool]((Get-Content examples/asset/processing/imported_assets/foo/b.cool.ron) -ne 'b')) { exit 1 }
          if ([bool]((Get-Content examples/asset/processing/imported_assets/foo/c.cool.ron) -ne 'cmodifiedXb')) { exit 1 }
          if ([bool]((Get-Content examples/asset/processing/imported_assets/d.cool.ron) -ne 'dcmodifiedXb')) { exit 1 }

          Write-Output "check loaded assets"
          if ([bool]((Get-Content a.text) -ne 'modifiedX')) { exit 1 }
          if ([bool]((Get-Content b.text) -ne 'b')) { exit 1 }
          if ([bool]((Get-Content c.text) -ne 'cmodifiedXb')) { exit 1 }
          if ([bool]((Get-Content d.text) -ne 'dcmodifiedXb')) { exit 1 }
        env:
          CI_TESTING_CONFIG: .github/example-run/alien_cake_addict.ron
